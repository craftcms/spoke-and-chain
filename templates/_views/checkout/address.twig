{# Pre layout #}
{% set updatedQueryString = craft.app.request.getQueryParam('updated', false) %}
{% if updatedQueryString and updatedQueryString == 'address' %}
  {% do craft.app.session.setFlash('notice', 'Address updated'|t) %}
{% endif %}

{# Layout #}
{% extends '_layouts/site' %}

{# Variables #}
{% set customer = craft.commerce.customers.customer %}
{% set addresses = customer ? customer.addresses : [] %}
{% set shippingPage = craft.entries({ section: 'checkout', type: 'shipping' }).one() %}
{% set checkoutPage = craft.entries({ section: 'checkout', type: 'checkout' }).one() %}

{# Blocks #}
{% block content %}
  {% if cart and (not cart.email or not cart.lineItems|length)  %}
    {% redirect checkoutPage ? checkoutPage.uri : 'checkout' %}
  {% endif %}
  {% set billingAddressSameAsShipping = (not cart.shippingAddressId and not cart.billingAddressId) or (cart.shippingAddressId and cart.billingAddressId and cart.shippingAddressId == cart.billingAddressId) %}
  <!-- Template: {{ _self }}.twig -->

  {# Heading #}
  <div class="bg-gray-300">
    <div class="container py-4 text-center">
      <h1>{{ entry.title }}</h1>
    </div>
  </div>

  <div class="container py-12">
    <div class="container flex justify-center">
      <div class="w-full max-w-2xl">
        <form method="post" x-data="{
          shippingAddress: '{{ currentUser and addresses|length and cart.shippingAddressId ? cart.shippingAddressId : '' }}',
        }">
          {{ csrfInput() }}
          {{ actionInput('commerce/cart/update-cart') }}
          {{ redirectInput(shippingPage ? shippingPage.uri : 'checkout/shipping') }}

          {% if entry.heading %}
            <h2>{{ entry.heading }}</h2>
          {% endif %}

            <h2 class="text-2xl mb-4">{{ 'Shipping Address'|t }}</h2>
            <div class="space-y-6">
                <div class="space-y-2">
                    {% if currentUser and addresses|length %}
                        {% for address in addresses %}
                            <div class="option-select">
                                <input id="shipping-address-{{ address.id }}" type="radio" name="shippingAddressId" value="{{ address.id }}" x-model="shippingAddress">

                                <label for="shipping-address-{{ address.id }}">
                                  {% include '_includes/components/address/lines' with { address: address } %}
                                </label>
                                {% include '_includes/components/address/editButton' with {
                                  address: address,
                                  redirectUrl: entry.uri
                                } %}
                            </div>
                        {% endfor %}

                        <div class="option-select">
                            <input id="shipping-address-new" type="radio" name="shippingAddressId" value="" x-model="shippingAddress">

                            <label for="shipping-address-new">
                              <strong>{{ 'Add address'|t }}</strong>
                            </label>
                        </div>
                        <template x-if="shippingAddress == ''">
                            {% include '_includes/components/address/fields' with {
                                modelName: 'shippingAddress',
                                model: cart.getErrors()|length and 'shippingAddress.' in cart.getErrors()|keys|join('||') ? cart.shippingAddress : {}
                            } %}
                        </template>

                    {% else %}
                        <div>
                            {% include '_includes/components/address/fields' with {
                                modelName: 'shippingAddress',
                                model: cart.shippingAddress
                            } %}
                        </div>
                    {% endif %}
                </div>

                {# Fallback default for `billingAddressSameAsShipping` #}
                {{ hiddenInput('billingAddressSameAsShipping', 0) }}

                <div x-data="{
                  billingSameAsShipping: {{ billingAddressSameAsShipping ? 'true' : 'false' }},
                  billingAddress: '{{ currentUser and addresses|length and cart.billingAddressId ? cart.billingAddressId : '' }}'
                }">
                    <div class="flex items-center">
                        <input class="checkbox" id="billingSameAsShipping" type="checkbox" name="billingAddressSameAsShipping" x-model="billingSameAsShipping" :checked="billingSameAsShipping">
                        <label class="ml-2" for="billingSameAsShipping">{{ 'Use address for billing'|t }}</label>
                    </div>

                    <template x-if="!billingSameAsShipping">
                      <div class="mt-4">
                        <div>
                          <h2 class="text-2xl mb-4">{{ 'Billing Address'|t }}</h2>
                        </div>
                        <div class="space-y-2">
                          {% if currentUser and addresses|length %}
                            {% for address in addresses %}
                              <div class="option-select">
                                <input id="billing-address-{{ address.id }}" type="radio" name="billingAddressId" value="{{ address.id }}" x-model="billingAddress">

                                <label for="billing-address-{{ address.id }}">
                                  {% for key, line in address.addressLines %}
                                    {% if key == 'name' %}<strong>{{ line }}</strong>{% else %}{{ line }}{% endif %}<br>
                                  {% endfor %}
                                </label>
                              </div>
                            {% endfor %}

                            <div class="option-select">
                              <input id="billing-address-new" type="radio" name="billingAddressId" value="" x-model="billingAddress">

                              <label for="billing-address-new">
                                <strong>{{ 'Add address'|t }}</strong>
                              </label>
                            </div>
                            <template x-if="billingAddress == ''">
                              {% include '_includes/components/address/fields' with {
                                modelName: 'billingAddress',
                                model: {}
                              } %}
                            </template>
                          {% else %}
                            <div>
                              {% include '_includes/components/address/fields' with {
                                modelName: 'billingAddress',
                                model: cart.billingAddress,
                                outputIdField: not (cart.billingAddress and cart.shippingAddress and cart.billingAddress.id == cart.shippingAddress.id)
                              } %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </template>
                </div>

                <div class="text-right">
                    <input class="button submit" type="submit" name="submit" value="{{ 'Next'|t }}">
                </div>
            </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% js at endBody %}
    {% if updatedQueryString and updatedQueryString == 'address' %}
      window.quickReplaceUri = '/{{ entry.uri }}';
    {% endif %}
{% endjs %}