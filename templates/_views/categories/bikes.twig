{# Layout #}
{% extends '_layouts/site' %}

{# Params #}
{# Get color slugs from the query string #}
{% set colorSlugs = craft.app.request.getQueryParam('colors') %}
{% set colorSlugs = colorSlugs ? colorSlugs|split('|') : [] %}
{# Get material slugs from the query string #}
{% set materialSlugs = craft.app.request.getQueryParam('material') %}
{% set materialSlugs = materialSlugs ? materialSlugs|split('|') : [] %}
{# Setup the filter params #}
{% set urlFilterParams = {
  colors: colorSlugs,
  material: materialSlugs
} %}
{% set productIds = [] %}

{# Variables #}
{% set isAllBikes = category is not defined %}
{# Get all the categories for the sidebar filter #}
{% set colorCategories = craft.categories({
  group: 'colors'
}).all() %}
{% set materialCategories = craft.categories({
  group: 'material'
}).all() %}
{% set bikeCategories = craft.categories({
  group: 'bikeTypes'
}).all() %}

{% if colorSlugs|length %}
  {% set relatedColors = colorCategories|filter(cc => cc.slug in colorSlugs) %}
  {% set productIds = craft.products({
    relatedTo: ['or', { targetElement: relatedColors, field: 'colors' }]
  }).ids() %}
{% endif %}

{% if materialSlugs|length %}
  {% set relatedMaterials = materialCategories|filter(mc => mc.slug in materialSlugs) %}
  {% set materialProductIds = craft.products({
    relatedTo: ['or', { targetElement: relatedMaterials, field: 'material' }]
  }).ids() %}
  {% if materialProductIds|length %}
    {% set productIds = productIds|filter(id => id in materialProductIds) %}
  {% endif %}
{% endif %}

{% set productQuery = craft.products({
  relatedTo: [category]
}) %}
{% if not productIds|length and colorSlugs|length  %}
  {# If there are no matching products for the other filters we need not return anything #}
  {% set products = [] %}
{% elseif productIds|length %}
  {% set productQuery = productQuery.id(productIds) %}
  {% set products = productQuery.all() %}
{% else %}
  {% set products = productQuery.all() %}
{% endif %}

{# Blocks #}
{% block content %}
  <!-- Template: {{ _self }}.twig -->

  {# Hero #}
  <div>
    {% include '_includes/components/hero' with {
      image: null,
      title: category.title,
      button: 'Click',
      short: true,
    } only %}
  </div>

  <div class="bg-gray-100">
    <div class="container py-4">
      <div class="flex">
        <div class="hidden md:block w-1/5">
          {% include '_includes/components/filters/bike' with {
            types: bikeCategories,
            selected: category is defined ? category.id : null,
          } only %}
          {% if colorCategories|length %}
            <hr>
            {% include '_includes/components/filters/color' with {
              heading: 'Color'|t('site'),
              showHeading: true,
              colors: colorCategories,
              urlFilterParams: urlFilterParams
            } only %}
          {% endif %}
          {% if materialCategories|length %}
            <hr>
            {% include '_includes/components/filters/material' with {
              heading: 'Material'|t('site'),
              showHeading: true,
              materials: materialCategories,
              urlFilterParams: urlFilterParams
            } only %}
          {% endif %}
        </div>
        <div class="w-full md:w-4/5">
          <div class="flex flex-wrap w-full -mx-2 -mb-4">
            {% for product in products %}
              <div class="w-full md:w-1/2 xl:w-1/3 px-2 pb-4">
                {% include '_includes/components/cards/product' with {
                  title: product.title,
                  image: true,
                  url: product.url
                } only %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}