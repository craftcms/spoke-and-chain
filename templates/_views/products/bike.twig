{# Layout #}
{% extends '_layouts/site' %}

{# Variables #}
{% set fixedHeader = false %}
{% set defaultVariant = product.defaultVariant %}
{% set productColors = product.colors.all() %}
{% set hasOverview = product.body ? true : false %}
{% set hasGeometry = product.geometry|length ? true : false %}
{% set reviews = craft.entries({ section: 'reviews', relatedTo: product, orderBy: 'postDate DESC' }).all() %}
{% set hasReviews = reviews and reviews|length %}
{% set averageRating = hasReviews ? 0 : false %}
{% set mostRecentReview = hasReviews ? reviews|first : false %}
{% for review in reviews %}
  {% set averageRating = averageRating + review.stars %}
  {% if loop.last %}
    {% set averageRating = (averageRating / reviews|length)|round(1) %}
  {% endif %}
{% endfor %}
{% set form = product.showForm ? craft.freeform.form('product', {}) : null %}
{% set images = product.productImages.all() %}

{# Blocks #}
{% block content %}
  <!-- Template: {{ _self }}.twig -->
  {# Product Nav #}
  {% include '_includes/components/products/nav' with {
    hasOverview : product.body ? true : false,
    hasGeometry : product.geometry|length ? true : false,
    hasReviews: hasReviews,
    hasForm: product.showForm and form,
  } %}

  {% if images|length %}
    <div>
      {% include '_includes/components/products/slider' with {
        images: images,
        id: 'product-slider-' ~ product.id
      } only %}
    </div>
  {% endif %}

  <div class="bg-gray-200">
    <div id="buy" class="container py-8">
      <form method="post">
        {{ csrfInput() }}
        {{ actionInput('commerce/cart/update-cart') }}
        {{ hiddenInput('cartUpdatedNotice', 'Added {name} to the cart.'|t('site', { name: product.title })) }}

        <div class="lg:flex lg:justify-between">
          {# Product Title #}
          <div class="lg:w-1/4">
            <h1 class="mt-0">{{ product.title }}</h1>
            <div>{{ defaultVariant.onSale ? defaultVariant.salePriceAsCurrency : defaultVariant.priceAsCurrency }}</div>
            {% if defaultVariant.onSale %}
              <div>
                <del>{{ defaultVariant.priceAsCurrency }}</del>
              </div>
            {% endif %}
          </div>

          {# Product Variants #}
          <div class="mt-6 lg:mt-0 lg:flex lg:justify-center">
            {# Colors #}
            {% if productColors %}
              <div class="flex">
                {% for color in productColors %}
                  <div class="h-5 w-5 rounded-full mt-3 mr-3"
                       style="background-color: {{ color.color }}"
                       aria-label="{{ color.title }}"
                       title="{{ color.title }}">
                    <span class="visuallyhidden">{{ color.title }}</span>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            {# Variants #}
            <div class="mt-6 lg:mt-0">
              {% include '_includes/components/forms/select' with {
                name: 'purchasableId',
                options: product.variants|map((v) => {
                  value: v.id,
                  label: v.title,
                  disabled: not v.hasStock()
                })
              } %}
            </div>
          </div>

          {# Product Buy #}
          <div class="mt-6 lg:mt-0 lg:w-1/4 lg:text-right lg:flex lg:items-center lg:justify-end">
            <input class="button" type="submit" name="submit"
                   value="{{ 'Add to cart'|t('site') }}">
          </div>
        </div>
      </form>
    </div>
  </div>

  {# Product Content #}
  <div class="bg-white py-8">
    <div class="container">
      <div class="max-w-3xl mx-auto">

        {# Overview #}
        {% if hasOverview %}
          <div id="overview" class="pt-16">
            <h2 class="text-xl">{{ 'Overview'|t }}</h2>
            {{ product.body }}
          </div>
        {% endif %}

        {# Geometry #}
        {% if hasGeometry %}
          <div id="geometry" class="pt-16">
            <h2 class="text-xl">Geometry</h2>

            <img class="w-full mt-4"
                 src="https://s3.amazonaws.com/craft-marinbikes/images/bikes/geometry/_bikeGeometry2048Wide/21_MRN_GEO_ALL_MULTITRAC_2048px.jpg"/>

            <div class="overflow-x-auto block max-w-full">
              <table class="data w-full mt-8">
                {% for row in product.geometry %}
                  {% if loop.first %}
                    <thead>
                      <tr>
                        <th><span class="visuallyhidden">{{ 'Type'|t }}</span></th>
                        <th class="text-center">{{ 'S'|t }}</th>
                        <th class="text-center">{{ 'M'|t }}</th>
                        <th class="text-center">{{ 'L'|t }}</th>
                        <th class="text-center">{{ 'XL'|t }}</th>
                      </tr>
                    </thead>
                  {% endif %}
                  <tbody>
                    <tr>
                      <td class="pl-0">{{ row.piece }}</td>
                      <td class="text-center">{{ row.s }}</td>
                      <td class="text-center">{{ row.m }}</td>
                      <td class="text-center">{{ row.l }}</td>
                      <td class="text-center">{{ row.xl }}</td>
                    </tr>
                  {% if loop.last %}
                  </tbody>
                  {% endif %}
                {% endfor %}
              </table>
            </div>
          </div>
        {% endif %}


        {# Reviews #}
        {% if hasReviews %}
          <div id="reviews" class="pt-16">
            <div>
              <h2 class="text-xl">{{ 'Reviews'|t }}</h2>
              <p>{{ '{number} review(s)'|t('site', { number: reviews|length }) }}</p>
              <p>{{ 'Average review {number}/5'|t('site', { number: averageRating }) }}</p>
            </div>

            <div class="mt-4">
              <h3>{{ 'Most Recent Review'|t }}</h3>
              {% include '_includes/components/products/review' with { review: mostRecentReview } only %}
            </div>

            {% if reviews|length > 1 %}
              <div x-data="modalButton('reviews', { id: {{ product.id }}, title: '{{ product.title|e('js') }}' }, 'slideout')" class="mt-4">
                <a class="button" href="#"
                   x-on:click.prevent="open($dispatch)">{{ 'See all reviews'|t }}</a>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if product.showForm and form %}
    <div id="question">
      {% include '_includes/components/content/form' with {
        block: {
          form: form,
          heading: 'Have a question? Ask us!'|t
        }
      } only %}
    </div>
  {% endif %}
{% endblock %}
