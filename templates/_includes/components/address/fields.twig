{% set countries = craft.commerce.countries.allEnabledCountriesAsList %}
{% set states = craft.commerce.states.allEnabledStatesAsListGroupedByCountryId %}
{% set countryId = model and model.countryId ? model.countryId : null %}
{% set stateId = model and model.stateId ? model.stateId : null %}

<div x-data="addresses()" x-init="countryId = {{ countryId ? "'#{countryId}'" : 'null' }}; stateId = {{ stateId ? "'#{stateId}'" : 'null' }}; modelName = '{{ modelName }}'; toggleStates()">
  {% if model and model.id %}
    {{ hiddenInput(modelName ~ '[id]', model.id) }}
  {% endif %}
  <div class="mt-3">
    <label for="{{ modelName }}-firstName">First Name</label>
    <input type="text" id="{{ modelName }}-firstName" class="w-full" name="{{ modelName }}[firstName]" value="{{ model ? model.firstName : '' }}">
    {% if model and model.getErrors('firstName') %}
      <div class="text-red-700">{{ model.getErrors('firstName')|join }}</div>
    {% endif %}
  </div>
  <div class="mt-3">
    <label for="{{ modelName }}-lastName">Last Name</label>
    <input type="text" id="{{ modelName }}-lastName" class="w-full" name="{{ modelName }}[lastName]" value="{{ model ? model.lastName : '' }}">
    {% if model and model.getErrors('lastName') %}
      <div class="text-red-700">{{ model.getErrors('lastName')|join }}</div>
    {% endif %}
  </div>
  <div class="mt-3">
    <label for="{{ modelName }}-address1">Address 1</label>
    <input type="text" id="{{ modelName }}-address1" class="w-full" name="{{ modelName }}[address1]" value="{{ model ? model.address1 : '' }}">
    {% if model and model.getErrors('address1') %}
      <div class="text-red-700">{{ model.getErrors('address1')|join }}</div>
    {% endif %}
  </div>

  <div class="mt-3">
    <label for="{{ modelName }}-address2">Address 2</label>
    <input type="text" id="{{ modelName }}-address2" class="w-full" name="{{ modelName }}[address2]" value="{{ model ? model.address2 : '' }}">
    {% if model and model.getErrors('address2') %}
      <div class="text-red-700">{{ model.getErrors('address2')|join }}</div>
    {% endif %}
  </div>

  <div class="flex -mx-4 mt-3">
    <div class="flex-1 mx-4">
      <label for="{{ modelName }}-city">City</label>
      <input type="text" id="{{ modelName }}-city" class="w-full" name="{{ modelName }}[city]" value="{{ model ? model.city : '' }}">
      {% if model and model.getErrors('city') %}
        <div class="text-red-700">{{ model.getErrors('city')|join }}</div>
      {% endif %}
    </div>
    <div class="flex-1 mx-4">
      <label for="{{ modelName }}-zipCode">Zip Code</label>
      <input type="text" id="{{ modelName }}-zipCode" class="w-full" name="{{ modelName }}[zipCode]" value="{{ model ? model.zipCode : '' }}">
      {% if model and model.getErrors('zipCode') %}
        <div class="text-red-700">{{ model.getErrors('zipCode')|join }}</div>
      {% endif %}
    </div>
  </div>
  <div class="mt-3">
    <label for="{{ modelName }}-phone">Phone</label>
    <input type="text" id="{{ modelName }}-phone" class="w-full" name="{{ modelName }}[phone]" value="{{ model ? model.phone : '' }}">
    {% if model and model.getErrors('phone') %}
      <span class="text-red-700">{{ model.getErrors('phone')|join }}</span>
    {% endif %}
  </div>
  <div class="flex -mx-4 mt-3">
    <div class="flex-1 mx-4">
      <label for="{{ modelName }}-countryId">Country *</label>
      <select class="js-address-country w-full" name="{{ modelName }}[countryId]" x-on:change="onChange">
        {% for key, option in countries %}
          {% set optionValue = (model ? model.countryId : '') %}
          <option value="{{ key }}" {% if key == optionValue %} selected{% endif %}>{{ option }}</option>
        {% endfor %}
      </select>
      {% if model and model.getErrors('countryId') %}
        <div class="text-red-700">{{ model.getErrors('countryId')|join }}</div>
      {% endif %}
    </div>
    <div class="flex-1 mx-4">
      <label for="{{ modelName }}-state">State</label>
      {% set options = (model and states[model.countryId] is defined ? states[model.countryId] : []) %}
      <select :id="stateSelectId" class="w-full" name="{{ modelName }}[stateValue]" x-model="stateId" x-show="showStateSelect">
        <template x-for="(state, index) in states()" :key="state.id" x-if="states().length">
          <option :value="state.id" x-text="state.name" :selected="state.id == stateId"></option>
        </template>
      </select>
      <input
          type="text"
          :id="stateTextId"
          class="w-full"
          :name="!showStateSelect ? '{{ modelName }}[stateValue]' : ''"
          value="{{ model ? model.stateName : '' }}"
          x-show="!showStateSelect"
      >
      {% if model and model.getErrors('stateValue') %}
        <div class="text-red-700">{{ model.getErrors('stateValue')|join }}</div>
      {% endif %}
    </div>
  </div>
</div>

{% js at head %}
  var addressStates = {{ craft.commerce.states.allEnabledStatesAsListGroupedByCountryId|json_encode|raw }};
{% endjs %}
